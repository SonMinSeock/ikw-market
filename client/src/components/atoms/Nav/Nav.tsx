import { useEffect, useState } from "react";
import * as S from "./Nav.style";
import { AiOutlineMenu } from "react-icons/ai";
import { Link, useLocation, useNavigate } from "react-router-dom";
import axios from "axios";
const Nav = () => {
  const [toogle, isToogle] = useState(false);
  const [user, setUser] = useState() as any;

  const NAVER_LOGIN = "네이버 로그인";

  const onToogleBtnClick = () => {
    isToogle((prev) => !prev);
  };

  const navigate = useNavigate();
  const location = useLocation();

  console.log(location);

  const getUserAPI = async () => {
    const res = await (await axios.get("http://localhost:3002/getUser", { withCredentials: true })).data;
    //console.log("get user api : ", res);
    setUser(res.user);
  };

  const logOutAPI = async () => {
    const res = await (await axios.get("http://localhost:3002/logout", { withCredentials: true })).data;
    setUser(res.user);
    window.location.reload();
  };

  useEffect(() => {
    getUserAPI();
  }, []);

  // 내 물건 팔기 페이지 리다이랙트
  const myProductNavigate = () => {
    if (!user) {
      return "/login";
    } else {
      return "/upload";
    }
  };

  // 내 프로필 페이지 리다이렉트
  const myProfileNavigate = () => {
    if (!user) {
      return "/login";
    } else {
      return "/profile";
    }
  };

  // 내 물건 팔기 페이지 리다이랙트
  const chatRoomNavigate = () => {
    if (!user) {
      return "/login";
    } else {
      return "/chat";
    }
  };

  // 로그아웃
  const onLogOut = async () => {
    if (user["social_id"]["social_name"] === NAVER_LOGIN) {
      localStorage.removeItem("com.naver.nid.oauth.state_token");
      console.log(localStorage.removeItem("com.naver.nid.oauth.state_token"));
      await logOutAPI();
    } else {
      try {
        await axios({
          method: "POST",
          url: "https://kapi.kakao.com/v1/user/logout",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
            Authorization: `Bearer ${location.state["kakao_access_token"]}`,
          },
        });
        await logOutAPI();
        window.location.href = "/";
      } catch (error: any) {
        // 이미 만료된 토큰일 경우
        if (error.response.data.code === -401) {
          window.location.href = "/";
        }
      }
    }
  };
  return (
    <S.Nav>
      <S.NavList>
        <Link to={myProductNavigate()}>
          <S.NavItem>
            <svg xmlns="http://www.w3.org/2000/svg" width="31" height="32" viewBox="0 0 31 32" fill="none">
              <path
                d="M26.2478 7.35875C26.1621 7.24642 26.0549 7.15607 25.9338 7.09408C25.8126 7.03209 25.6805 6.99998 25.5468 7H7.129L6.57071 3.6425C6.49424 3.18167 6.27248 2.76484 5.94408 2.46468C5.61568 2.16452 5.20147 2.00007 4.77368 2H2.71292C2.47068 2 2.23836 2.10536 2.06708 2.29289C1.89579 2.48043 1.79956 2.73478 1.79956 3C1.79956 3.26522 1.89579 3.51957 2.06708 3.70711C2.23836 3.89464 2.47068 4 2.71292 4H4.76797L7.68615 21.5362C7.77211 22.0563 7.98203 22.5423 8.29467 22.945C7.86316 23.3863 7.55171 23.9498 7.39485 24.573C7.23799 25.1962 7.24185 25.8549 7.40601 26.4759C7.57016 27.0968 7.8882 27.6559 8.32484 28.0911C8.76149 28.5263 9.29968 28.8205 9.87975 28.9412C10.4598 29.062 11.0591 29.0044 11.6111 28.775C12.1632 28.5456 12.6464 28.1533 13.0072 27.6416C13.368 27.1299 13.5923 26.5187 13.6553 25.8759C13.7182 25.2332 13.6173 24.5838 13.3638 24H18.5494C18.3451 24.4684 18.2393 24.981 18.24 25.5C18.24 26.1922 18.4275 26.8689 18.7787 27.4445C19.13 28.0201 19.6293 28.4687 20.2134 28.7336C20.7975 28.9985 21.4403 29.0678 22.0604 28.9327C22.6805 28.7977 23.2501 28.4644 23.6972 27.9749C24.1443 27.4854 24.4487 26.8617 24.5721 26.1828C24.6954 25.5039 24.6321 24.8001 24.3901 24.1606C24.1482 23.5211 23.7385 22.9744 23.2128 22.5899C22.6871 22.2053 22.069 22 21.4367 22H10.3817C10.1678 22 9.96069 21.9177 9.79649 21.7677C9.63229 21.6176 9.52141 21.4092 9.48318 21.1787L9.12126 19H22.3649C23.0066 18.9999 23.6279 18.7532 24.1205 18.303C24.6131 17.8527 24.9458 17.2275 25.0605 16.5362L26.4488 8.17875C26.4723 8.0343 26.4665 7.88596 26.4317 7.74424C26.397 7.60253 26.3342 7.47092 26.2478 7.35875ZM11.8465 25.5C11.8465 25.7967 11.7661 26.0867 11.6156 26.3334C11.4651 26.58 11.2511 26.7723 11.0007 26.8858C10.7504 26.9993 10.4749 27.0291 10.2092 26.9712C9.94341 26.9133 9.69929 26.7704 9.50769 26.5607C9.31609 26.3509 9.1856 26.0836 9.13274 25.7926C9.07988 25.5017 9.10701 25.2001 9.2107 24.926C9.3144 24.6519 9.49 24.4176 9.7153 24.2528C9.9406 24.088 10.2055 24 10.4765 24C10.8398 24 11.1883 24.158 11.4452 24.4393C11.7021 24.7206 11.8465 25.1022 11.8465 25.5ZM22.8068 25.5C22.8068 25.7967 22.7264 26.0867 22.5759 26.3334C22.4253 26.58 22.2114 26.7723 21.961 26.8858C21.7107 26.9993 21.4352 27.0291 21.1695 26.9712C20.9037 26.9133 20.6596 26.7704 20.468 26.5607C20.2764 26.3509 20.1459 26.0836 20.093 25.7926C20.0402 25.5017 20.0673 25.2001 20.171 24.926C20.2747 24.6519 20.4503 24.4176 20.6756 24.2528C20.9009 24.088 21.1658 24 21.4367 24C21.8001 24 22.1486 24.158 22.4055 24.4393C22.6624 24.7206 22.8068 25.1022 22.8068 25.5ZM23.2635 16.1787C23.2251 16.4098 23.1137 16.6187 22.9488 16.7689C22.7839 16.919 22.576 17.0008 22.3615 17H8.78903L7.46123 9H24.452L23.2635 16.1787Z"
                fill="#343330"
              />
            </svg>
            <span>내 물건 팔기</span>
          </S.NavItem>
        </Link>
        <Link to={myProfileNavigate()}>
          <S.NavItem>
            <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
              <path
                d="M16 3C13.4288 3 10.9154 3.76244 8.77759 5.1909C6.63975 6.61935 4.97351 8.64968 3.98957 11.0251C3.00563 13.4006 2.74819 16.0144 3.2498 18.5362C3.75141 21.0579 4.98953 23.3743 6.80762 25.1924C8.6257 27.0105 10.9421 28.2486 13.4638 28.7502C15.9856 29.2518 18.5995 28.9944 20.9749 28.0104C23.3503 27.0265 25.3807 25.3603 26.8091 23.2224C28.2376 21.0846 29 18.5712 29 16C28.9964 12.5533 27.6256 9.24882 25.1884 6.81163C22.7512 4.37445 19.4467 3.00364 16 3ZM9.26001 24.6875C9.98342 23.5561 10.98 22.625 12.1579 21.9801C13.3358 21.3351 14.6571 20.9971 16 20.9971C17.3429 20.9971 18.6642 21.3351 19.8421 21.9801C21.02 22.625 22.0166 23.5561 22.74 24.6875C20.8129 26.1862 18.4413 26.9999 16 26.9999C13.5587 26.9999 11.1871 26.1862 9.26001 24.6875ZM12 15C12 14.2089 12.2346 13.4355 12.6741 12.7777C13.1137 12.1199 13.7384 11.6072 14.4693 11.3045C15.2002 11.0017 16.0044 10.9225 16.7804 11.0769C17.5563 11.2312 18.269 11.6122 18.8284 12.1716C19.3878 12.731 19.7688 13.4437 19.9231 14.2196C20.0775 14.9956 19.9983 15.7998 19.6955 16.5307C19.3928 17.2616 18.8801 17.8864 18.2223 18.3259C17.5645 18.7654 16.7911 19 16 19C14.9391 19 13.9217 18.5786 13.1716 17.8284C12.4214 17.0783 12 16.0609 12 15ZM24.22 23.3013C23.1047 21.6851 21.5365 20.4348 19.7125 19.7075C20.6923 18.9358 21.4072 17.878 21.7579 16.6811C22.1086 15.4843 22.0776 14.2079 21.6693 13.0294C21.2609 11.851 20.4955 10.8291 19.4794 10.1059C18.4634 9.38262 17.2472 8.99397 16 8.99397C14.7528 8.99397 13.5366 9.38262 12.5206 10.1059C11.5045 10.8291 10.7391 11.851 10.3307 13.0294C9.92238 14.2079 9.8914 15.4843 10.2421 16.6811C10.5928 17.878 11.3077 18.9358 12.2875 19.7075C10.4635 20.4348 8.89529 21.6851 7.78001 23.3013C6.37072 21.7165 5.4496 19.7581 5.12756 17.6619C4.80553 15.5657 5.09631 13.4211 5.9649 11.4864C6.83349 9.55163 8.24285 7.90922 10.0233 6.75692C11.8037 5.60462 13.8792 4.99156 16 4.99156C18.1208 4.99156 20.1963 5.60462 21.9768 6.75692C23.7572 7.90922 25.1665 9.55163 26.0351 11.4864C26.9037 13.4211 27.1945 15.5657 26.8724 17.6619C26.5504 19.7581 25.6293 21.7165 24.22 23.3013Z"
                fill="#343330"
              />
            </svg>
            <span>내 정보</span>
          </S.NavItem>
        </Link>
        <Link to={chatRoomNavigate()}>
          <S.NavItem>
            <svg xmlns="http://www.w3.org/2000/svg" width="33" height="32" viewBox="0 0 33 32" fill="none">
              <path
                d="M27.5 10H23.5V6C23.5 5.46957 23.2893 4.96086 22.9142 4.58579C22.5391 4.21071 22.0304 4 21.5 4H5.5C4.96957 4 4.46086 4.21071 4.08579 4.58579C3.71071 4.96086 3.5 5.46957 3.5 6V22C3.50059 22.1881 3.55423 22.3723 3.65478 22.5313C3.75532 22.6903 3.89868 22.8177 4.06839 22.8989C4.2381 22.9801 4.42728 23.0118 4.61418 22.9903C4.80108 22.9689 4.97814 22.8951 5.125 22.7775L9.5 19.25V23C9.5 23.5304 9.71071 24.0391 10.0858 24.4142C10.4609 24.7893 10.9696 25 11.5 25H23.1987L27.875 28.7775C28.0519 28.9206 28.2724 28.9991 28.5 29C28.7652 29 29.0196 28.8946 29.2071 28.7071C29.3946 28.5196 29.5 28.2652 29.5 28V12C29.5 11.4696 29.2893 10.9609 28.9142 10.5858C28.5391 10.2107 28.0304 10 27.5 10ZM8.81875 17.2225L5.5 19.9062V6H21.5V17H9.4475C9.21863 17 8.9967 17.0786 8.81875 17.2225ZM27.5 25.9062L24.1812 23.2225C24.0043 23.0794 23.7838 23.0009 23.5562 23H11.5V19H21.5C22.0304 19 22.5391 18.7893 22.9142 18.4142C23.2893 18.0391 23.5 17.5304 23.5 17V12H27.5V25.9062Z"
                fill="#343330"
              />
            </svg>
            <span>채팅</span>
          </S.NavItem>
        </Link>
        <S.NavItem>
          {user ? <span onClick={onLogOut}>로그아웃</span> : <span onClick={() => navigate("/login")}>로그인</span>}
        </S.NavItem>
      </S.NavList>
      {/* 모바일 버전 */}
      <S.ToogleBtn onClick={onToogleBtnClick}>
        <AiOutlineMenu />
      </S.ToogleBtn>
      <S.MenuBox $isMenu={toogle}>
        <S.MenuList>
          <Link to={myProductNavigate()}>
            <S.MenuItem>
              <svg xmlns="http://www.w3.org/2000/svg" width="31" height="32" viewBox="0 0 31 32" fill="none">
                <path
                  d="M26.2478 7.35875C26.1621 7.24642 26.0549 7.15607 25.9338 7.09408C25.8126 7.03209 25.6805 6.99998 25.5468 7H7.129L6.57071 3.6425C6.49424 3.18167 6.27248 2.76484 5.94408 2.46468C5.61568 2.16452 5.20147 2.00007 4.77368 2H2.71292C2.47068 2 2.23836 2.10536 2.06708 2.29289C1.89579 2.48043 1.79956 2.73478 1.79956 3C1.79956 3.26522 1.89579 3.51957 2.06708 3.70711C2.23836 3.89464 2.47068 4 2.71292 4H4.76797L7.68615 21.5362C7.77211 22.0563 7.98203 22.5423 8.29467 22.945C7.86316 23.3863 7.55171 23.9498 7.39485 24.573C7.23799 25.1962 7.24185 25.8549 7.40601 26.4759C7.57016 27.0968 7.8882 27.6559 8.32484 28.0911C8.76149 28.5263 9.29968 28.8205 9.87975 28.9412C10.4598 29.062 11.0591 29.0044 11.6111 28.775C12.1632 28.5456 12.6464 28.1533 13.0072 27.6416C13.368 27.1299 13.5923 26.5187 13.6553 25.8759C13.7182 25.2332 13.6173 24.5838 13.3638 24H18.5494C18.3451 24.4684 18.2393 24.981 18.24 25.5C18.24 26.1922 18.4275 26.8689 18.7787 27.4445C19.13 28.0201 19.6293 28.4687 20.2134 28.7336C20.7975 28.9985 21.4403 29.0678 22.0604 28.9327C22.6805 28.7977 23.2501 28.4644 23.6972 27.9749C24.1443 27.4854 24.4487 26.8617 24.5721 26.1828C24.6954 25.5039 24.6321 24.8001 24.3901 24.1606C24.1482 23.5211 23.7385 22.9744 23.2128 22.5899C22.6871 22.2053 22.069 22 21.4367 22H10.3817C10.1678 22 9.96069 21.9177 9.79649 21.7677C9.63229 21.6176 9.52141 21.4092 9.48318 21.1787L9.12126 19H22.3649C23.0066 18.9999 23.6279 18.7532 24.1205 18.303C24.6131 17.8527 24.9458 17.2275 25.0605 16.5362L26.4488 8.17875C26.4723 8.0343 26.4665 7.88596 26.4317 7.74424C26.397 7.60253 26.3342 7.47092 26.2478 7.35875ZM11.8465 25.5C11.8465 25.7967 11.7661 26.0867 11.6156 26.3334C11.4651 26.58 11.2511 26.7723 11.0007 26.8858C10.7504 26.9993 10.4749 27.0291 10.2092 26.9712C9.94341 26.9133 9.69929 26.7704 9.50769 26.5607C9.31609 26.3509 9.1856 26.0836 9.13274 25.7926C9.07988 25.5017 9.10701 25.2001 9.2107 24.926C9.3144 24.6519 9.49 24.4176 9.7153 24.2528C9.9406 24.088 10.2055 24 10.4765 24C10.8398 24 11.1883 24.158 11.4452 24.4393C11.7021 24.7206 11.8465 25.1022 11.8465 25.5ZM22.8068 25.5C22.8068 25.7967 22.7264 26.0867 22.5759 26.3334C22.4253 26.58 22.2114 26.7723 21.961 26.8858C21.7107 26.9993 21.4352 27.0291 21.1695 26.9712C20.9037 26.9133 20.6596 26.7704 20.468 26.5607C20.2764 26.3509 20.1459 26.0836 20.093 25.7926C20.0402 25.5017 20.0673 25.2001 20.171 24.926C20.2747 24.6519 20.4503 24.4176 20.6756 24.2528C20.9009 24.088 21.1658 24 21.4367 24C21.8001 24 22.1486 24.158 22.4055 24.4393C22.6624 24.7206 22.8068 25.1022 22.8068 25.5ZM23.2635 16.1787C23.2251 16.4098 23.1137 16.6187 22.9488 16.7689C22.7839 16.919 22.576 17.0008 22.3615 17H8.78903L7.46123 9H24.452L23.2635 16.1787Z"
                  fill="#343330"
                />
              </svg>
              <span>내 물건 팔기</span>
            </S.MenuItem>
          </Link>
          <Link to={myProfileNavigate()}>
            <S.MenuItem>
              <svg xmlns="http://www.w3.org/2000/svg" width="32" height="32" viewBox="0 0 32 32" fill="none">
                <path
                  d="M16 3C13.4288 3 10.9154 3.76244 8.77759 5.1909C6.63975 6.61935 4.97351 8.64968 3.98957 11.0251C3.00563 13.4006 2.74819 16.0144 3.2498 18.5362C3.75141 21.0579 4.98953 23.3743 6.80762 25.1924C8.6257 27.0105 10.9421 28.2486 13.4638 28.7502C15.9856 29.2518 18.5995 28.9944 20.9749 28.0104C23.3503 27.0265 25.3807 25.3603 26.8091 23.2224C28.2376 21.0846 29 18.5712 29 16C28.9964 12.5533 27.6256 9.24882 25.1884 6.81163C22.7512 4.37445 19.4467 3.00364 16 3ZM9.26001 24.6875C9.98342 23.5561 10.98 22.625 12.1579 21.9801C13.3358 21.3351 14.6571 20.9971 16 20.9971C17.3429 20.9971 18.6642 21.3351 19.8421 21.9801C21.02 22.625 22.0166 23.5561 22.74 24.6875C20.8129 26.1862 18.4413 26.9999 16 26.9999C13.5587 26.9999 11.1871 26.1862 9.26001 24.6875ZM12 15C12 14.2089 12.2346 13.4355 12.6741 12.7777C13.1137 12.1199 13.7384 11.6072 14.4693 11.3045C15.2002 11.0017 16.0044 10.9225 16.7804 11.0769C17.5563 11.2312 18.269 11.6122 18.8284 12.1716C19.3878 12.731 19.7688 13.4437 19.9231 14.2196C20.0775 14.9956 19.9983 15.7998 19.6955 16.5307C19.3928 17.2616 18.8801 17.8864 18.2223 18.3259C17.5645 18.7654 16.7911 19 16 19C14.9391 19 13.9217 18.5786 13.1716 17.8284C12.4214 17.0783 12 16.0609 12 15ZM24.22 23.3013C23.1047 21.6851 21.5365 20.4348 19.7125 19.7075C20.6923 18.9358 21.4072 17.878 21.7579 16.6811C22.1086 15.4843 22.0776 14.2079 21.6693 13.0294C21.2609 11.851 20.4955 10.8291 19.4794 10.1059C18.4634 9.38262 17.2472 8.99397 16 8.99397C14.7528 8.99397 13.5366 9.38262 12.5206 10.1059C11.5045 10.8291 10.7391 11.851 10.3307 13.0294C9.92238 14.2079 9.8914 15.4843 10.2421 16.6811C10.5928 17.878 11.3077 18.9358 12.2875 19.7075C10.4635 20.4348 8.89529 21.6851 7.78001 23.3013C6.37072 21.7165 5.4496 19.7581 5.12756 17.6619C4.80553 15.5657 5.09631 13.4211 5.9649 11.4864C6.83349 9.55163 8.24285 7.90922 10.0233 6.75692C11.8037 5.60462 13.8792 4.99156 16 4.99156C18.1208 4.99156 20.1963 5.60462 21.9768 6.75692C23.7572 7.90922 25.1665 9.55163 26.0351 11.4864C26.9037 13.4211 27.1945 15.5657 26.8724 17.6619C26.5504 19.7581 25.6293 21.7165 24.22 23.3013Z"
                  fill="#343330"
                />
              </svg>
              <span>내 정보</span>
            </S.MenuItem>
          </Link>
          <Link to={chatRoomNavigate()}>
            <S.MenuItem>
              <svg xmlns="http://www.w3.org/2000/svg" width="33" height="32" viewBox="0 0 33 32" fill="none">
                <path
                  d="M27.5 10H23.5V6C23.5 5.46957 23.2893 4.96086 22.9142 4.58579C22.5391 4.21071 22.0304 4 21.5 4H5.5C4.96957 4 4.46086 4.21071 4.08579 4.58579C3.71071 4.96086 3.5 5.46957 3.5 6V22C3.50059 22.1881 3.55423 22.3723 3.65478 22.5313C3.75532 22.6903 3.89868 22.8177 4.06839 22.8989C4.2381 22.9801 4.42728 23.0118 4.61418 22.9903C4.80108 22.9689 4.97814 22.8951 5.125 22.7775L9.5 19.25V23C9.5 23.5304 9.71071 24.0391 10.0858 24.4142C10.4609 24.7893 10.9696 25 11.5 25H23.1987L27.875 28.7775C28.0519 28.9206 28.2724 28.9991 28.5 29C28.7652 29 29.0196 28.8946 29.2071 28.7071C29.3946 28.5196 29.5 28.2652 29.5 28V12C29.5 11.4696 29.2893 10.9609 28.9142 10.5858C28.5391 10.2107 28.0304 10 27.5 10ZM8.81875 17.2225L5.5 19.9062V6H21.5V17H9.4475C9.21863 17 8.9967 17.0786 8.81875 17.2225ZM27.5 25.9062L24.1812 23.2225C24.0043 23.0794 23.7838 23.0009 23.5562 23H11.5V19H21.5C22.0304 19 22.5391 18.7893 22.9142 18.4142C23.2893 18.0391 23.5 17.5304 23.5 17V12H27.5V25.9062Z"
                  fill="#343330"
                />
              </svg>
              <span>채팅</span>
            </S.MenuItem>
          </Link>
          <S.MenuItem>
            {user ? <span>로그아웃</span> : <span onClick={() => navigate("/login")}>로그인</span>}
          </S.MenuItem>
        </S.MenuList>
      </S.MenuBox>
    </S.Nav>
  );
};

export default Nav;
